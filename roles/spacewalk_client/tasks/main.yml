---
- name: Install spacewalk client repo.
  yum:
    name: https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8-client/epel-7-x86_64/00742644-spacewalk-repo/spacewalk-client-repo-2.8-11.el7.centos.noarch.rpm
    state: present

- name: Install spacewalk client packages.
  yum:
   name:
     - rhn-client-tools
     - rhn-check
     - rhn-setup
     - rhnsd
     - m2crypto
     - yum-rhn-plugin

- name: Restart spacewalk daemon.
  systemd:
   name: rhnsd.service
   state: restarted

- name: Register client at the spacewalk server.
  rhn_register:
   state: present
   activationkey: "{{activation_key}}"
   server_url: "{{spacewalk_server_url}}"
   channels: "{{rhn_channels}}"
  register: result
  until: result is succeeded
  retries: 3
  delay: 3
  ignore_errors: yes

- name: Disable gpgcheck.
  command: sed -i 's/gpgcheck = 1/gpgcheck = 0/g' /etc/yum/pluginconf.d/rhnplugin.conf
  args:
    warn: false

- name: Remove all current repo config files.
  shell: "rm -rf /etc/yum.repos.d/*"
  args:
    warn: false

- name: Clear the yum cache.
  command: "yum clean all"
  args:
    warn: false
  ignore_errors: yes

- name: Upgrade all packages to version specified in spacewalk channel.
  yum:
   name: '*'
   state: latest
