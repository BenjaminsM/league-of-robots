---
#
# We only check if the envsync account for deploy admins exists; Hence we DO NOT create it here!
# Depending on wether this account comes from an LDAP or is a local account,
# it must have been created earlier on in the play.
#
- name: 'Check if envsync group is present (without creating one if not existing yet).'
  group:
    name: "{{ envsync_group }}"
    state: present
  become: false

- name: 'Check if envsync user is present (without creating one if not existing yet).'
  user:
    name: "{{ envsync_user }}"
    group: "{{ envsync_user }}"
    groups: "{{ envsync_group }}"
    home: "/home/{{ envsync_user }}"
    create_home: no
    append: no
  become: false

#
# Configure environment synchronization account.
#
- name: 'Initialize envsync account creating home dir if it did not exist yet.'
  command: "su - {{ envsync_user }}"
  register: envsync_login
  failed_when: envsync_login.rc != 0
  changed_when: "'Creating home directory' in envsync_login.stdout"
  become: true

- name: 'Allow passwordless sudo to the environment synchronization account for deploy admin users.'
  lineinfile:
    dest: '/etc/sudoers'
    line: "%{{ envsync_group }}    ALL=(envsync_user)    NOPASSWD:ALL"
  become: true

- name: 'Insert/update block into ~/.bashrc to ensure we use the correct environment for syncing.'
  blockinfile:
    dest: "/home/{{ envsync_user }}/.bashrc"
    block: |
      [ $(id -gn) = {{ envsync_group }} ] || exec newgrp {{ envsync_group }}
      cd
      umask 0002
      module load depad-utils
      module list
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Setup environment for environment synchronization account."
    insertafter: EOF
    create: no
  become: true
...